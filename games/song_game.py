import random
import re
from linebot.models import TextSendMessage

class SongGame:
    def __init__(self, line_bot_api):
        self.line_bot_api = line_bot_api
        self.current_song = None
        self.correct_answer = None

        # ๐ถ 100 ุฃุบููุฉ ูู ุงูููุงููู ุงูุนุฑุจ ุงูุฃูุซุฑ ุดูุฑุฉ (ุจุนุฏ ุงูุชุตุญูุญ)
        self.songs = [
            # ุนุจุฏุงููุฌูุฏ ุนุจุฏุงููู
            {"lyrics": "ุฃุญุจู ููู ุฃูุง ูุฏุฑู", "artist": "ุนุจุฏุงููุฌูุฏ ุนุจุฏุงููู", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ุงุญุณ ุงูู ูููุชู", "artist": "ุนุจุฏุงููุฌูุฏ ุนุจุฏุงููู", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ูุง ูุตุญ ุฅูุง ุงูุตุญูุญ", "artist": "ุนุจุฏุงููุฌูุฏ ุนุจุฏุงููู", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ููุจู ุนูู ุทูู ูุดุชุงู", "artist": "ุนุจุฏุงููุฌูุฏ ุนุจุฏุงููู", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ุฑููุจ", "artist": "ุนุจุฏุงููุฌูุฏ ุนุจุฏุงููู", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ุฑูุญู ุชุญุจู", "artist": "ุนุจุฏุงููุฌูุฏ ุนุจุฏุงููู", "nationality": "ุณุนูุฏู"},

            # ูุงุฌุฏ ุงููููุฏุณ
            {"lyrics": "ุฃูุฑ ุงููู", "artist": "ูุงุฌุฏ ุงููููุฏุณ", "nationality": "ุนุฑุงูู"},
            {"lyrics": "ุจุนุซุฑุชูู", "artist": "ูุงุฌุฏ ุงููููุฏุณ", "nationality": "ุนุฑุงูู"},
            {"lyrics": "ุฃูุณุงู ูุง ุฃูุฏุฑ", "artist": "ูุงุฌุฏ ุงููููุฏุณ", "nationality": "ุนุฑุงูู"},
            {"lyrics": "ุณูุฏ ุงูุณุงุญุฉ", "artist": "ูุงุฌุฏ ุงููููุฏุณ", "nationality": "ุนุฑุงูู"},
            {"lyrics": "ููู ูููู", "artist": "ูุงุฌุฏ ุงููููุฏุณ", "nationality": "ุนุฑุงูู"},
            {"lyrics": "ุชูุงุฏูู", "artist": "ูุงุฌุฏ ุงููููุฏุณ", "nationality": "ุนุฑุงูู"},

            # ุฃุตุงูุฉ ูุตุฑู
            {"lyrics": "ููุชุดู ูุฑ ุงูุญูููุฉ", "artist": "ุฃุตุงูุฉ ูุตุฑู", "nationality": "ุณูุฑูุฉ"},
            {"lyrics": "ูุง ูุบุฑูุฑ", "artist": "ุฃุตุงูุฉ ูุตุฑู", "nationality": "ุณูุฑูุฉ"},
            {"lyrics": "ุฃุฎุจุงุฑ ุฌุฑูุฆุฉ", "artist": "ุฃุตุงูุฉ ูุตุฑู", "nationality": "ุณูุฑูุฉ"},
            {"lyrics": "ุตุฏูุฉ", "artist": "ุฃุตุงูุฉ ูุตุฑู", "nationality": "ุณูุฑูุฉ"},
            {"lyrics": "ุจูุช ุฃูุงุจุฑ", "artist": "ุฃุตุงูุฉ ูุตุฑู", "nationality": "ุณูุฑูุฉ"},

            # ุฑุงุดุฏ ุงููุงุฌุฏ
            {"lyrics": "ุนูููู ุณูุฏ", "artist": "ุฑุงุดุฏ ุงููุงุฌุฏ", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ููุช ุฃุจุญุซ ุนูู", "artist": "ุฑุงุดุฏ ุงููุงุฌุฏ", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ูุง ุญุจูุจู ุงุณุชูู", "artist": "ุฑุงุดุฏ ุงููุงุฌุฏ", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ุชุนุจุช ูุฃูุง ุฃูุงุฏู", "artist": "ุฑุงุดุฏ ุงููุงุฌุฏ", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ูุงููู ุดุงุบู ููุฑู", "artist": "ุฑุงุดุฏ ุงููุงุฌุฏ", "nationality": "ุณุนูุฏู"},

            # ูุญูุฏ ุนุจุฏู
            {"lyrics": "ููู ูุงู ุงูุณุญุจ", "artist": "ูุญูุฏ ุนุจุฏู", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ูุฏู ุฃุดููู ูู ููู", "artist": "ูุญูุฏ ุนุจุฏู", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ูุง ุฃูู ุงูููู", "artist": "ูุญูุฏ ุนุจุฏู", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ุงูุฃูุงูู", "artist": "ูุญูุฏ ุนุจุฏู", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ูููุฉ ุฎููุณ", "artist": "ูุญูุฏ ุนุจุฏู", "nationality": "ุณุนูุฏู"},

            # ุนูุฑู ุฏูุงุจ
            {"lyrics": "ููุฑ ุงูุนูู", "artist": "ุนูุฑู ุฏูุงุจ", "nationality": "ูุตุฑู"},
            {"lyrics": "ุชููู ูุนุงู", "artist": "ุนูุฑู ุฏูุงุจ", "nationality": "ูุตุฑู"},
            {"lyrics": "ูุฏุงู ูุฑุงูุชูุง", "artist": "ุนูุฑู ุฏูุงุจ", "nationality": "ูุตุฑู"},
            {"lyrics": "ุญุจูุจู ููุง ุนูู ุจุงูู", "artist": "ุนูุฑู ุฏูุงุจ", "nationality": "ูุตุฑู"},
            {"lyrics": "ูุนุงู ููุจู", "artist": "ุนูุฑู ุฏูุงุจ", "nationality": "ูุตุฑู"},
            {"lyrics": "ุนูุด ุจุดููู", "artist": "ุนูุฑู ุฏูุงุจ", "nationality": "ูุตุฑู"},

            # ุชุงูุฑ ุญุณูู
            {"lyrics": "ูุงุณููู ููู", "artist": "ุชุงูุฑ ุญุณูู", "nationality": "ูุตุฑู"},
            {"lyrics": "ุนูุดูู ูุนุงู", "artist": "ุชุงูุฑ ุญุณูู", "nationality": "ูุตุฑู"},
            {"lyrics": "ูู ุจุนุชูู ุฌูุงุจ", "artist": "ุชุงูุฑ ุญุณูู", "nationality": "ูุตุฑู"},
            {"lyrics": "ุญุงุณุณ ุจููุง", "artist": "ุชุงูุฑ ุญุณูู", "nationality": "ูุตุฑู"},
            {"lyrics": "ุตุจุงุญ ุงูุฎูุฑ", "artist": "ุชุงูุฑ ุญุณูู", "nationality": "ูุตุฑู"},

            # ุฃุญูุงู
            {"lyrics": "ูุณุชุนุฌู ููู", "artist": "ุฃุญูุงู", "nationality": "ุฅูุงุฑุงุชูุฉ"},
            {"lyrics": "ุฑูู ูุงุญุฏ", "artist": "ุฃุญูุงู", "nationality": "ุฅูุงุฑุงุชูุฉ"},
            {"lyrics": "ูุฐุง ุฃูุง", "artist": "ุฃุญูุงู", "nationality": "ุฅูุงุฑุงุชูุฉ"},
            {"lyrics": "ุนูู ูุซุฑ ุงูููุง", "artist": "ุฃุญูุงู", "nationality": "ุฅูุงุฑุงุชูุฉ"},
            {"lyrics": "ุฃุจุฑุญู", "artist": "ุฃุญูุงู", "nationality": "ุฅูุงุฑุงุชูุฉ"},

            # ุดูุฑูู ุนุจุฏ ุงูููุงุจ
            {"lyrics": "ูุดุงุนุฑ", "artist": "ุดูุฑูู ุนุจุฏ ุงูููุงุจ", "nationality": "ูุตุฑูุฉ"},
            {"lyrics": "ุงู ูุง ููู", "artist": "ุดูุฑูู ุนุจุฏ ุงูููุงุจ", "nationality": "ูุตุฑูุฉ"},
            {"lyrics": "ุญุจูุจู ูุง ูุจุถ ุงูุญูุงุฉ", "artist": "ุดูุฑูู ุนุจุฏ ุงูููุงุจ", "nationality": "ูุตุฑูุฉ"},
            {"lyrics": "ุจุชุญุจ ูุงุณ", "artist": "ุดูุฑูู ุนุจุฏ ุงูููุงุจ", "nationality": "ูุตุฑูุฉ"},
            {"lyrics": "ุฌุฑุญ ุชุงูู", "artist": "ุดูุฑูู ุนุจุฏ ุงูููุงุจ", "nationality": "ูุตุฑูุฉ"},

            # ูุงุธู ุงูุณุงูุฑ
            {"lyrics": "ุฒูุฏููู ุนุดูุงู", "artist": "ูุงุธู ุงูุณุงูุฑ", "nationality": "ุนุฑุงูู"},
            {"lyrics": "ุงูุชูู ุงููุดูุงุฑ", "artist": "ูุงุธู ุงูุณุงูุฑ", "nationality": "ุนุฑุงูู"},
            {"lyrics": "ุญุงููุฉ ุงููุฏููู", "artist": "ูุงุธู ุงูุณุงูุฑ", "nationality": "ุนุฑุงูู"},
            {"lyrics": "ูุง ุชุฒูุฏููู ููุนุฉ", "artist": "ูุงุธู ุงูุณุงูุฑ", "nationality": "ุนุฑุงูู"},
            {"lyrics": "ูุฏุฑุณุฉ ุงูุญุจ", "artist": "ูุงุธู ุงูุณุงูุฑ", "nationality": "ุนุฑุงูู"},

            # ูุงูุณู ุนุฌุฑู
            {"lyrics": "ุขุฎ ูุง ููุจู", "artist": "ูุงูุณู ุนุฌุฑู", "nationality": "ูุจูุงููุฉ"},
            {"lyrics": "ุนููู ุนููู", "artist": "ูุงูุณู ุนุฌุฑู", "nationality": "ูุจูุงููุฉ"},
            {"lyrics": "ูุง ุจูุงุช", "artist": "ูุงูุณู ุนุฌุฑู", "nationality": "ูุจูุงููุฉ"},
            {"lyrics": "ุฃููุงู ุจูู", "artist": "ูุงูุณู ุนุฌุฑู", "nationality": "ูุจูุงููุฉ"},
            {"lyrics": "ูุง ุชูุฌู ููุง", "artist": "ูุงูุณู ุนุฌุฑู", "nationality": "ูุจูุงููุฉ"},

            # ุฅููุณุง
            {"lyrics": "ุจุณุชูุงู", "artist": "ุฅููุณุง", "nationality": "ูุจูุงููุฉ"},
            {"lyrics": "ุนูุณ ุงููู ุดุงูููููุง", "artist": "ุฅููุณุง", "nationality": "ูุจูุงููุฉ"},
            {"lyrics": "ุฑูุญ ูุง ุญุจูุจู", "artist": "ุฅููุณุง", "nationality": "ูุจูุงููุฉ"},
            {"lyrics": "ุฃุณุนุฏ ูุงุญุฏุฉ", "artist": "ุฅููุณุง", "nationality": "ูุจูุงููุฉ"},
            {"lyrics": "ุนุง ุจุงูู", "artist": "ุฅููุณุง", "nationality": "ูุจูุงููุฉ"},

            # ุญุณูู ุงูุฌุณูู
            {"lyrics": "ุจุงูุจูุท ุงูุนุฑูุถ", "artist": "ุญุณูู ุงูุฌุณูู", "nationality": "ุฅูุงุฑุงุชู"},
            {"lyrics": "ุจุดุฑุฉ ุฎูุฑ", "artist": "ุญุณูู ุงูุฌุณูู", "nationality": "ุฅูุงุฑุงุชู"},
            {"lyrics": "ูุญุชุงุฌู", "artist": "ุญุณูู ุงูุฌุณูู", "nationality": "ุฅูุงุฑุงุชู"},
            {"lyrics": "ุงูุณุงู ุตุนุจ", "artist": "ุญุณูู ุงูุฌุณูู", "nationality": "ุฅูุงุฑุงุชู"},
            {"lyrics": "ููุฏุชู", "artist": "ุญุณูู ุงูุฌุณูู", "nationality": "ุฅูุงุฑุงุชู"},

            # ูุงุฆู ูููุฑู
            {"lyrics": "ุดู ุญูู", "artist": "ูุงุฆู ูููุฑู", "nationality": "ูุจูุงูู"},
            {"lyrics": "ุจุชุญุจููู ููุง ูุฃ", "artist": "ูุงุฆู ูููุฑู", "nationality": "ูุจูุงูู"},
            {"lyrics": "ุฃูุง ููุงู", "artist": "ูุงุฆู ูููุฑู", "nationality": "ูุจูุงูู"},
            {"lyrics": "ููุจู ุงุชุฎุจู", "artist": "ูุงุฆู ูููุฑู", "nationality": "ูุจูุงูู"},

            # ุฑุงุดุฏ ุงููุงุฑุณ
            {"lyrics": "ุจูุช ุนูู", "artist": "ุฑุงุดุฏ ุงููุงุฑุณ", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ูุง ุธุงูููู", "artist": "ุฑุงุดุฏ ุงููุงุฑุณ", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ุณูุฉ ุงูุนูุฏุฉ", "artist": "ุฑุงุดุฏ ุงููุงุฑุณ", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ุญุจูุชู ุจููุฉ", "artist": "ุฑุงุดุฏ ุงููุงุฑุณ", "nationality": "ุณุนูุฏู"},

            # ุฑุงุจุญ ุตูุฑ
            {"lyrics": "ูููู ุนูู", "artist": "ุฑุงุจุญ ุตูุฑ", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ูุง ููุจู ุญุจูุจู", "artist": "ุฑุงุจุญ ุตูุฑ", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ุงูุญุจ ุงูุฃูู", "artist": "ุฑุงุจุญ ุตูุฑ", "nationality": "ุณุนูุฏู"},
            {"lyrics": "ูุง ุจูู ุดู", "artist": "ุฑุงุจุญ ุตูุฑ", "nationality": "ุณุนูุฏู"},

            # ุฃุตูู ุฃุจู ุจูุฑ
            {"lyrics": "ุงููุฌููู", "artist": "ุฃุตูู ุฃุจู ุจูุฑ", "nationality": "ูููู"},
            {"lyrics": "ุฏูุฑุชู", "artist": "ุฃุตูู ุฃุจู ุจูุฑ", "nationality": "ูููู"},
            {"lyrics": "ุนุงูุด ูุนุงูุง", "artist": "ุฃุตูู ุฃุจู ุจูุฑ", "nationality": "ูููู"},
            {"lyrics": "ุบุฑูุจ ุงูุฏุงุฑ", "artist": "ุฃุตูู ุฃุจู ุจูุฑ", "nationality": "ูููู"},

            # ูุคุงุฏ ุนุจุฏ ุงููุงุญุฏ
            {"lyrics": "ูุง ุบุงูุจ ุนูู", "artist": "ูุคุงุฏ ุนุจุฏ ุงููุงุญุฏ", "nationality": "ูููู"},
            {"lyrics": "ุฃูุช ุงูุฃูุงู", "artist": "ูุคุงุฏ ุนุจุฏ ุงููุงุญุฏ", "nationality": "ูููู"},
            {"lyrics": "ุญุจูุจู ุถุงุน ููู", "artist": "ูุคุงุฏ ุนุจุฏ ุงููุงุญุฏ", "nationality": "ูููู"},

            # ูููุฏ ุงูุดุงูู
            {"lyrics": "ุฃูุช ููุจู", "artist": "ูููุฏ ุงูุดุงูู", "nationality": "ุนุฑุงูู"},
            {"lyrics": "ูุง ูุงุณููู", "artist": "ูููุฏ ุงูุดุงูู", "nationality": "ุนุฑุงูู"},
            {"lyrics": "ุณุงูู ูู ุฎูุงูู", "artist": "ูููุฏ ุงูุดุงูู", "nationality": "ุนุฑุงูู"},

            # ุฃุตูู ูููู
            {"lyrics": "ููุจู ูุนุงู", "artist": "ุฃุตูู ูููู", "nationality": "ุนุฑุงููุฉ"},
            {"lyrics": "ุฃุดุชุงู ูู", "artist": "ุฃุตูู ูููู", "nationality": "ุนุฑุงููุฉ"},
            {"lyrics": "ุญุจู ุบูุฑ", "artist": "ุฃุตูู ูููู", "nationality": "ุนุฑุงููุฉ"},

            # ููุฑูุฒ
            {"lyrics": "ุฒูุฑุฉ ุงููุฏุงุฆู", "artist": "ููุฑูุฒ", "nationality": "ูุจูุงููุฉ"},
            {"lyrics": "ุณุฃูููู ุงููุงุณ", "artist": "ููุฑูุฒ", "nationality": "ูุจูุงููุฉ"},
            {"lyrics": "ูููู ุงูุช", "artist": "ููุฑูุฒ", "nationality": "ูุจูุงููุฉ"},

            # ูุงุฌุฏุฉ ุงูุฑููู
            {"lyrics": "ูููุงุช", "artist": "ูุงุฌุฏุฉ ุงูุฑููู", "nationality": "ูุจูุงููุฉ"},
            {"lyrics": "ุจุนุฏู ุนูู ุจุงูู", "artist": "ูุงุฌุฏุฉ ุงูุฑููู", "nationality": "ูุจูุงููุฉ"},
        ]

    def normalize_text(self, text):
        text = text.strip().lower()
        text = re.sub(r'^ุงู', '', text)
        text = text.replace('ุฃ', 'ุง').replace('ุฅ', 'ุง').replace('ุข', 'ุง')
        text = text.replace('ุฉ', 'ู').replace('ู', 'ู')
        text = re.sub(r'[\u064B-\u065F]', '', text)
        return text

    def start_game(self):
        song_data = random.choice(self.songs)
        self.current_song = song_data
        self.correct_answer = song_data["artist"]

        message = (
            f"๐ต ุฎูู ุงุณู ุงููุบูู ุฃู ุงููุบููุฉ:\n\n"
            f"\"{song_data['lyrics']}\"\n\n"
            f"๐ชถ *ุชูููุญ:* (ุงูุฌูุณูุฉ: {song_data['nationality']})"
        )
        return TextSendMessage(text=message)

    def check_answer(self, answer, user_id, display_name):
        if not self.current_song:
            return None

        user_answer = self.normalize_text(answer)
        correct_answer = self.normalize_text(self.correct_answer)

        if user_answer in correct_answer or correct_answer in user_answer:
            points = 15
            msg = (
                f"โ ุฃุญุณูุช ูุง {display_name}!\n"
                f"๐ค ุงููุบูู ูู: {self.correct_answer}\n"
                f"โญ +{points} ููุทุฉ"
            )
            self.current_song = None
            return {
                'message': msg,
                'points': points,
                'won': True,
                'game_over': True,
                'response': TextSendMessage(text=msg)
            }
        else:
            msg = (
                f"โ ุฎุทุฃ!\n"
                f"ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูู: {self.correct_answer}"
            )
            self.current_song = None
            return {
                'message': msg,
                'points': 0,
                'game_over': True,
                'response': TextSendMessage(text=msg)
            }
